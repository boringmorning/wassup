<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
        <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
        <style>
            body{
                text-align: center;
            }
            canvas {
                border:1px solid #d3d3d3;
                background-color: #f1f1f1;
                display: block;
                margin: 0 auto;
            }
        </style>
    </head>
    <body onload="startGame()">
        <script>
            var myGameArea;
            var myGamePiece;
            var myObstacles = [];
            var count = [];
            var images = [];
            var myScore;
            var pause = false; //if the game is paused set it to true
            var terminal = false;
            var speed = 5;
            var Ob_speed = -5;
            var life = 3;
            var spark = 0; // control the time of invincible status
            var bump = false; // if bump into obstacle set it to truth
            var points=0; // points of passing Obstacles
            var mute = false;


            function startGame() {
                myGameArea.start();
                myGamePiece = new component(50, 50, 'right.png', 10, 225, "image"); 
                myScore = new textcomponent("20px", "Arial", "black", 380, 20);
                myLife = new textcomponent("20px", "serif", "blue", 380, 40);
            }



            var myGameArea = {
                canvas : document.createElement("canvas"),
                title : document.createElement("h3"),
                restart_bt : document.createElement("input"),

                start : function() {
                    var node = document.createTextNode("LAIMO RUN");
                    this.title.appendChild(node);
                    document.body.insertBefore(this.title, document.body.childNodes[0]);

                    this.canvas.width = 500;
                    this.canvas.height = 500;
                    this.context = this.canvas.getContext("2d");
                    document.body.insertBefore(this.canvas, document.body.childNodes[1]);
                    this.frameNo = 0;
                    this.interval = setInterval(updateGameArea, 20);

                    this.restart_bt.setAttribute("type","button");
                    this.restart_bt.style.display = "none";
                    this.restart_bt.style.margin = "0 auto";
                    this.restart_bt.id = "restart";
                    this.restart_bt.value = "Restart?";
                    this.restart_bt.align = "center";
                    this.restart_bt.addEventListener("click", myGameArea.restart);



                    
                    document.body.insertBefore(document.createElement("br"), document.body.childNodes[2]);
                    document.body.insertBefore(this.restart_bt, document.body.childNodes[3]);

                    window.addEventListener('keydown', function (e) {
                        //record of every pressed down keyboards
                        kbcontrol('down', e);
                    })
                    window.addEventListener('keyup', function (e) {        
                        //reset the record of every keyup buttons on keyboards
                        kbcontrol('up', e);
                    })    

                },

                clear : function() {
                    this.context.fillStyle = '#f1f1f1';
                    this.context.fillRect(0, 0, this.canvas.width, this.canvas.height);
                },
                stop : function() {
                    //implement pause function
                },
                restart : function(){
                    //implement restart function
                    life = 3;
                    points = 0;
                    myObstacles = [];
                    count = [];
                    myGamePiece.x = 10;
                    myGamePiece.y = 255;
                    bump = false;
                    spark = 0;
                    Ob_speed = -5;
                    terminal = false;
                    document.getElementById("restart").style.display = 'none';

                    mute = false;
                }
            }

            //function of creating component
            function component(width, height, color, x, y, type) {
                this.width = width;
                this.height = height;
                this.speedX = 0;
                this.speedY = 0;    
                this.x = x;
                this.y = y;    


                this.type = type;
                if (type == "image") {
                    this.image = new Image();
                    this.image.src = color;
                }
                else {
                    // this.speedX = Ob_speed;
                }

                this.update = function() {
                    ctx = myGameArea.context;
                    if (type == "image") {
                        if(!bump) {
                            ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
                        }
                        else {
                            if(spark%20>=0 && spark%20<=4 && spark!=0) {
                                ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
                            }
                        }
                        spark--;
                        if(spark==1) {
                            bump = false;
                        } 
                        else if(spark<=0) {
                            spark = 0;
                        }
                    } 
                    else {
                        ctx.fillStyle = color;
                        ctx.fillRect(this.x, this.y, this.width, this.height);
                    }

                }
                //update component's position
                this.newPos = function() {
                    var borderx = myGameArea.canvas.width - this.width;
                    var bordery = myGameArea.canvas.height - this.height;
                    if(this.type=='image') {
                        if(this.x<0){this.x=0};
                        if(this.x>borderx){this.x=borderx};
                        if(this.y<0){this.y=0};
                        if(this.y>bordery){this.y=bordery};
                    }

                    this.x += this.speedX;
                    this.y += this.speedY;        
                }

                //crash function detect function
                this.crashWith = function(otherobj) {
                    var myleft = this.x;
                    var myright = this.x + (this.width);
                    var mytop = this.y;
                    var mybottom = this.y + (this.height);
                    var otherleft = otherobj.x;
                    var otherright = otherobj.x + (otherobj.width);
                    var othertop = otherobj.y;
                    var otherbottom = otherobj.y + (otherobj.height);
                    var crash = true;
                    if ((mybottom < othertop) || (mytop > otherbottom) || (myright < otherleft) || (myleft > otherright)) {
                        crash = false;
                    }
                    return crash;
                }
            }

            //function of creating text as a component
            function textcomponent(size, family, color, x, y) {
                this.size = size;
                this.family = family;
                this.color = color;
                this.x = x;
                this.y = y;    
                this.update = function() {
                    ctx = myGameArea.context;
                    ctx.font = this.size + " " + this.family;
                    ctx.fillStyle = color;
                    ctx.fillText(this.text, this.x, this.y);

                }
            }

            //The everyinterval function returns true if the current framenumber corresponds with the given interval.
            function everyinterval(n) {
                if ((myGameArea.frameNo / n) % 1 == 0) {
                    return true;
                }
                return false;
            }


            function kbcontrol(keyboard_control, event){
                if(keyboard_control=='down') {
                    if(event.keyCode == 37){
                        myGamePiece.image.src = 'left.png';
                        myGamePiece.speedX = -speed;
                    }
                    else if(event.keyCode == 38){
                        myGamePiece.image.src = 'up.png';
                        myGamePiece.speedY = -speed;                        
                    }
                    else if(event.keyCode == 39){
                        myGamePiece.image.src = 'right.png';
                        myGamePiece.speedX = speed;                           
                    }
                    else if(event.keyCode == 40){
                        myGamePiece.image.src = 'down.png';
                        myGamePiece.speedY = speed;                        
                    }
                    else if(event.keyCode == 32){
                        pause = !pause;
                    }

                }
                else if(keyboard_control=='up') {
                    if(event.keyCode == 37){
                        myGamePiece.speedX = 0;
                    }
                    else if(event.keyCode == 38){
                        myGamePiece.speedY = 0;                        
                    }
                    else if(event.keyCode == 39){
                        myGamePiece.speedX = 0;                           
                    }
                    else if(event.keyCode == 40){
                        myGamePiece.speedY = 0;                        
                    }
                    else if(event.keyCode == 82){
                        myGameArea.restart();
                    }
                    else if(event.keyCode == 77){
                        mute = !mute;
                        music_control();
                    }
                }
            }


            function updateGameArea() {

                if(!terminal){
                    if(!pause) {
                        myGameArea.clear();
                        var x, height, gap, minHeight, maxHeight, minGap, maxGap;
                        for (i = 0; i < myObstacles.length; i++) {
                            var index = Math.floor(i/2)
                            if (myGamePiece.crashWith(myObstacles[i])) {
                                //implement action when crash into obstacle
                                if(bump == false) {
                                    bump = true;
                                    spark = 160;
                                    life--;
                                    if(life==0) {
                                        terminal = true;
                                        document.getElementById("restart").style.display = 'block';
                                        break
                                    }
                                }
                                count[index] = true;
                            }
                            else {
                                if(myGamePiece.x>myObstacles[i].x+myObstacles[i].width && count[index]==false) {
                                    points ++;
                                    Ob_speed -= 0.3;
                                    count[index] = true;
                                }
                            }
                        }

                        //update Obstacles  
                        myGameArea.frameNo += 1;
                        if ((myGameArea.frameNo == 1 || everyinterval(50))) {
                            //implement random moving obstacles
                            var Ob_y = Math.floor(300*Math.random())+50
                            myObstacles.push(new component(10, Ob_y, "green", 500, 0));
                            myObstacles.push(new component(10, 400-Ob_y, "green", 500, Ob_y+150));
                            count.push(false);
                            
                        }
                        for (i = 0; i < myObstacles.length; i += 1) {
                            myObstacles[i].newPos();
                            myObstacles[i].update();
                            myObstacles[i].speedX = Ob_speed;
                        }

                        //update gamepiece
                        //implement of making gamepiece invincible state when bumping into obstacle
                        myGamePiece.newPos();
                        myGamePiece.update();

                        //update score and life
                        myScore.text = "SCORE: " + points;
                        myScore.update();
                        myLife.text = "Life: " + life;
                        myLife.update();
                    }                    
                }
            }
            function music_control(){
                if(mute){
                    document.getElementById("music").pause();
                }
                else{
                    document.getElementById("music").play();
                }
            }
        </script>
        <audio id="music"src="LAKEY INSPIRED - The Process.mp3" loop autoplay style="visibility: hidden"></audio>
    </body>
</html>
